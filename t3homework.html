<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>T3_Base - Homework Manager</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    :root{
      --bg-dark:#121216; --bg-light:#f4f6f8;
      --card-dark:#17171a; --card-light:#ffffff;
      --text-dark:#eaeaea; --text-light:#111827;
      --muted:#9aa1ab; --accent:#2563eb; /* blue */
    }
    [data-theme="dark"] {
      --bg:var(--bg-dark); --card:var(--card-dark); --text:var(--text-dark);
    }
    [data-theme="light"] {
      --bg:var(--bg-light); --card:var(--card-light); --text:var(--text-light);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column}
    .navbar{background:var(--card);position:sticky;top:0;z-index:20;padding:14px 18px;box-shadow:0 1px 6px rgba(0,0,0,.15)}
    .nav-inner{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand i{font-size:20px}
    .right-controls{display:flex;align-items:center;gap:8px}
    .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;display:inline-flex;gap:8px;align-items:center}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,.06);color:var(--text);padding:8px 10px;border-radius:8px}
    main{max-width:1100px;margin:20px auto;padding:0 16px;flex:1;width:100%}
    .hero{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .title{font-size:1.6rem;font-weight:700}
    .subtitle{color:var(--muted);margin-top:6px}
    .layout{display:grid;grid-template-columns:1fr 420px;gap:20px;margin-top:18px}
    @media(max-width:980px){ .layout{grid-template-columns:1fr} }
    /* Cards */
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.15);}
    .homework-list{display:grid;gap:12px}
    .hw-card{display:flex;flex-direction:column;gap:8px}
    .hw-meta{color:var(--muted);font-size:13px}
    .hw-images{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .hw-images .img-wrap{position:relative;width:120px;height:84px;overflow:hidden;border-radius:8px;background:#222;display:flex;align-items:center;justify-content:center}
    .hw-images img{width:100%;height:100%;object-fit:cover;display:block}
    .more-overlay{position:absolute;inset:0;background:rgba(0,0,0,.6);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
    .hw-desc{white-space:pre-wrap;color:var(--text);font-size:14px}
    /* form */
    .form .field{margin-bottom:10px}
    label{display:block;margin-bottom:6px;color:var(--muted);font-size:13px}
    input[type="text"],input[type="date"],textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,.15);background:transparent;color:var(--text)}
    textarea{min-height:92px;resize:vertical}
    input[type=file]{display:block}
    .preview-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .preview-row img{width:80px;height:56px;object-fit:cover;border-radius:6px}
    /* upload progress */
    .progress-wrap{margin-top:8px;background:rgba(0,0,0,.12);border-radius:8px;overflow:hidden;height:12px}
    .progress-bar{height:100%;width:0%;background:var(--accent);transition:width .2s}
    .progress-text{font-size:13px;color:var(--muted);margin-top:6px}
    /* gallery modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:60}
    .modal.open{display:flex}
    .modal .modal-content{max-width:90vw;max-height:90vh;background:transparent;display:flex;align-items:center;justify-content:center}
    .modal img{max-width:100%;max-height:100%;object-fit:contain;border-radius:8px}
    footer{padding:14px;text-align:center;background:transparent;color:var(--muted);font-size:13px}
  </style>
  <!-- Firebase SDKs -->
  <script type="module">
    // IMPORTANT: Replace firebaseConfig with your project's keys
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, serverTimestamp, deleteDoc, query, orderBy
    } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore.js";
    import { getStorage, ref as stRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // DOM refs
    const themeToggle = () => {
      const body = document.body;
      const current = body.getAttribute('data-theme') || 'dark';
      body.setAttribute('data-theme', current === 'dark' ? 'light' : 'dark');
    };

    // Elements
    document.addEventListener('DOMContentLoaded', () => {
      // elements
      const uploadToggleBtn = document.getElementById('uploadToggle');
      const formContainer = document.getElementById('formContainer');
      const homeworkForm = document.getElementById('homeworkForm');
      const previewRow = document.getElementById('previewRow');
      const inputFiles = document.getElementById('homeworkImages');
      const hwList = document.getElementById('homeworkList');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const themeBtn = document.getElementById('themeBtn');
      const modal = document.getElementById('modal');
      const modalImage = document.getElementById('modalImage');

      themeBtn.addEventListener('click', () => themeToggle());

      uploadToggleBtn.addEventListener('click', () => {
        formContainer.style.display = formContainer.style.display === 'block' ? 'none' : 'block';
      });

      // preview multiple files
      inputFiles.addEventListener('change', (e) => {
        previewRow.innerHTML = '';
        const files = Array.from(e.target.files).slice(0, 20); // limit preview to 20
        files.forEach(file => {
          const r = new FileReader();
          r.onload = (ev) => {
            const img = document.createElement('img');
            img.src = ev.target.result;
            previewRow.appendChild(img);
          };
          r.readAsDataURL(file);
        });
      });

      // submit handler
      homeworkForm.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const teacher = document.getElementById('teacherName').value.trim() || 'Unknown';
        const subject = document.getElementById('subject').value.trim() || 'General';
        const description = document.getElementById('description').value.trim();
        const dueDate = document.getElementById('dueDate').value || '';
        const files = Array.from(inputFiles.files || []);
        const section = 'T3'; // enforced

        // 1) create doc with metadata (no images yet)
        const docRef = await addDoc(collection(db, 'homework'), {
          teacher, subject, description, dueDate, section, createdAt: serverTimestamp(), images: []
        });

        // 2) if files exist, upload them and update doc
        if (files.length > 0) {
          // compute total bytes for aggregated progress
          const totalBytes = files.reduce((s,f) => s + f.size, 0);
          let bytesTransferred = 0;
          progressBar.style.width = '0%';
          progressText.textContent = `Uploading 0%`;
          progressBar.parentElement.style.display = 'block';

          // upload sequentially (or parallel); we'll upload sequentially to simplify aggregated accounting
          const uploadedUrls = [];
          for (const file of files) {
            const storagePath = `homework/${docRef.id}/${Date.now()}_${file.name.replace(/\s/g,'_')}`;
            const sRef = stRef(storage, storagePath);
            const uploadTask = uploadBytesResumable(sRef, file);

            // wrapper to await each file upload and listen progress
            await new Promise((resolve, reject) => {
              uploadTask.on('state_changed',
                (snapshot) => {
                  // update aggregated progress
                  // bytesTransferredForThisFile = snapshot.bytesTransferred (but we must track per file - easier to use snapshot and approximate)
                  // We'll calculate aggregated progress as (bytesTransferredSoFarWithoutThisFile + currentFileSnapshot)/totalBytes
                  const currentFileTransferred = snapshot.bytesTransferred;
                  // compute aggregated
                  const percent = Math.round(((bytesTransferred + currentFileTransferred) / totalBytes) * 100);
                  progressBar.style.width = percent + '%';
                  progressText.textContent = `Uploading ${percent}%`;
                },
                (err) => { console.error('Upload error', err); reject(err); },
                async () => {
                  // file finished
                  const url = await getDownloadURL(uploadTask.snapshot.ref);
                  uploadedUrls.push(url);
                  // add the bytes of this file to bytesTransferred so next file progress starts after it
                  bytesTransferred += file.size;
                  // update aggregated percent after file done
                  const percentDone = Math.round((bytesTransferred / totalBytes) * 100);
                  progressBar.style.width = percentDone + '%';
                  progressText.textContent = `Uploading ${percentDone}%`;
                  resolve();
                }
              );
            });
          } // end for files

          // update doc with uploadedUrls
          await updateDoc(doc(db, 'homework', docRef.id), { images: uploadedUrls });
          progressBar.style.width = '100%';
          progressText.textContent = `Upload complete`;
          setTimeout(() => { progressBar.parentElement.style.display = 'none'; progressBar.style.width = '0%'; progressText.textContent = ''; }, 900);
        } else {
          // no images - immediate update handled earlier
        }

        // reset form
        homeworkForm.reset();
        previewRow.innerHTML = '';
        formContainer.style.display = 'none';
      });

      // Real-time listener: show all docs in 'homework' ordered by createdAt desc
      const q = query(collection(db,'homework'), orderBy('createdAt','desc'));
      onSnapshot(q, async (snap) => {
        // client-side cleanup: remove docs older than 10 days
        const now = Date.now();
        const TEN_DAYS_MS = 10*24*60*60*1000;
        const toDelete = [];
        const items = [];
        snap.forEach(docSnap => {
          const data = docSnap.data();
          const createdAt = data.createdAt && data.createdAt.toMillis ? data.createdAt.toMillis() : (data.createdAt ? new Date(data.createdAt).getTime() : now);
          if (now - createdAt > TEN_DAYS_MS) {
            toDelete.push(docSnap.ref);
          } else {
            items.push({ id: docSnap.id, data });
          }
        });
        // delete expired docs (best-effort; requires permission)
        for (const dref of toDelete) {
          try { await deleteDoc(dref); } catch(e){ console.warn('Could not delete expired doc (rules?)', e); }
        }

        // render items
        hwList.innerHTML = items.length ? '' : '<div class="card">No assignments yet</div>';
        items.forEach(item => {
          const hw = item.data;
          // ensure section is T3 (filter)
          if (hw.section && hw.section !== 'T3') return;
          const el = document.createElement('div');
          el.className = 'card hw-card';
          // images: show up to 4, last shows +X if more
          let imagesHtml = '';
          if (hw.images && hw.images.length > 0) {
            const imgs = hw.images;
            const maxShow = 4;
            const shown = imgs.slice(0, maxShow);
            imagesHtml = '<div class="hw-images">';
            shown.forEach((src, idx) => {
              if (idx === maxShow - 1 && imgs.length > maxShow) {
                imagesHtml += `<div class="img-wrap" data-idx="${idx}" data-doc="${item.id}"><img src="${src}" alt="img"/><div class="more-overlay">+${imgs.length - (maxShow-1)} more</div></div>`;
              } else {
                imagesHtml += `<div class="img-wrap" data-idx="${idx}" data-doc="${item.id}"><img src="${src}" alt="img"/></div>`;
              }
            });
            imagesHtml += '</div>';
          }
          const createdAtDisplay = hw.createdAt && hw.createdAt.toDate ? hw.createdAt.toDate().toLocaleString() : '';
          el.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong style="font-size:15px">${escapeHtml(hw.subject)}</strong></div>
              <div class="hw-meta">${escapeHtml(createdAtDisplay)}</div>
            </div>
            <div class="hw-meta">By ${escapeHtml(hw.teacher)} | Due: ${escapeHtml(hw.dueDate || '—')}</div>
            ${imagesHtml}
            <div class="hw-desc">${escapeHtml(hw.description || '')}</div>
          `;
          hwList.appendChild(el);
          // attach click handlers for images inside this card
          const wrappers = el.querySelectorAll('.img-wrap');
          wrappers.forEach(w => {
            w.style.cursor = 'pointer';
            w.addEventListener('click', () => {
              const docId = w.getAttribute('data-doc');
              // fetch doc images from snap data (we have item.data)
              const allImgs = hw.images || [];
              // open modal with first image index
              const idx = parseInt(w.getAttribute('data-idx')||0,10);
              openModal(allImgs, idx);
            });
          });
        });
      });

      // Modal gallery functions
      function openModal(images, startIndex=0) {
        if (!images || images.length === 0) return;
        modal.classList.add('open');
        showModalImage(images, startIndex);
        modal.dataset.images = JSON.stringify(images);
        modal.dataset.index = startIndex;
      }
      function showModalImage(images, index) {
        const idx = ((index % images.length) + images.length) % images.length;
        modalImage.src = images[idx];
        modal.dataset.index = idx;
      }
      modal.addEventListener('click', (e) => {
        if (e.target === modal || e.target.id === 'closeModal') {
          modal.classList.remove('open');
        } else {
          // click left/right to navigate
          const rect = modalImage.getBoundingClientRect();
          const x = e.clientX - rect.left;
          if (x < rect.width/2) {
            // prev
            const images = JSON.parse(modal.dataset.images || '[]');
            let idx = parseInt(modal.dataset.index || '0',10);
            idx = (idx - 1 + images.length) % images.length;
            showModalImage(images, idx);
          } else {
            // next
            const images = JSON.parse(modal.dataset.images || '[]');
            let idx = parseInt(modal.dataset.index || '0',10);
            idx = (idx + 1) % images.length;
            showModalImage(images, idx);
          }
        }
      });

      // helper
      function escapeHtml(str='') {
        return String(str)
          .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
          .replaceAll('"','&quot;').replaceAll("'","&#039;");
      }
    });
  </script>
</head>
<body data-theme="dark">
  <nav class="navbar">
    <div class="nav-inner">
      <div class="brand"><i class="fas fa-graduation-cap"></i> T3_Base</div>
      <div class="right-controls">
        <button id="themeBtn" class="ghost"><i class="fas fa-adjust"></i></button>
        <button id="uploadToggle" class="btn"><i class="fas fa-upload"></i> Upload Homework</button>
      </div>
    </div>
  </nav>

  <main>
    <div class="hero">
      <div>
        <div class="title">Homework Manager — T3</div>
        <div class="subtitle">Shared assignments — images supported. Items auto-expire after 10 days.</div>
      </div>
      <div style="text-align:right"></div>
    </div>

    <div class="layout">
      <!-- Left: list -->
      <section>
        <div id="homeworkList" class="homework-list"></div>
      </section>

      <!-- Right: form -->
      <aside>
        <div id="formContainer" class="card" style="display:none">
          <form id="homeworkForm" class="form">
            <div class="field">
              <label for="teacherName">Teacher Name</label>
              <input id="teacherName" type="text" placeholder="e.g., Mrs. Sharma" />
            </div>

            <div class="field">
              <label for="homeworkImages">Upload Images (you can select multiple)</label>
              <input id="homeworkImages" type="file" accept="image/*" multiple />
              <div id="previewRow" class="preview-row"></div>
            </div>

            <div class="field">
              <label for="subject">Subject</label>
              <input id="subject" type="text" placeholder="e.g., Mathematics" required />
            </div>

            <div class="field">
              <label for="description">Description</label>
              <textarea id="description" placeholder="Notes, page numbers, instructions..."></textarea>
            </div>

            <div class="field">
              <label for="dueDate">Due Date</label>
              <input id="dueDate" type="date" />
            </div>

            <div class="field">
              <button type="submit" class="btn submit-btn">Submit</button>
              <div style="height:10px"></div>
              <div class="progress-wrap" style="display:none">
                <div id="progressBar" class="progress-bar"></div>
              </div>
              <div id="progressText" class="progress-text"></div>
            </div>
          </form>
        </div>
      </aside>
    </div>
  </main>

  <!-- modal gallery -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <img id="modalImage" src="" alt="preview" />
    </div>
  </div>

  <footer>
    Homework Manager © T3_Base — Everyone can view & upload homework
  </footer>
</body>
</html>
