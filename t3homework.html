<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
import { neon } from '@netlify/neon';
const sql = neon(); // automatically uses env NETLIFY_DATABASE_URL
const [post] = await sql`SELECT * FROM posts WHERE id = ${postId}`;

const homeworkForm = document.getElementById('homeworkForm');
const inputFiles = document.getElementById('homeworkImages');
const hwList = document.getElementById('homeworkList');

homeworkForm.addEventListener('submit', async (e) => {
  e.preventDefault();

  const teacher = document.getElementById('teacherName').value.trim();
  const subject = document.getElementById('subject').value.trim();
  const description = document.getElementById('description').value.trim();
  const dueDate = document.getElementById('dueDate').value;
  const files = Array.from(inputFiles.files);

  const imageUrls = [];

  for (const file of files) {
    const fileExt = file.name.split('.').pop();
    const fileName = `${Date.now()}-${Math.random().toString(36).substring(2)}.${fileExt}`;
    const { data, error } = await supabase.storage
      .from('homework-images')
      .upload(fileName, file);

    if (error) { alert(error.message); return; }

    const { publicUrl } = supabase.storage.from('homework-images').getPublicUrl(fileName);
    imageUrls.push(publicUrl);
  }

  const { data, error } = await supabase.from('homework').insert([{
    teacher, subject, description, due_date: dueDate, section: 'T3', images: imageUrls
  }]);

  if (error) alert(error.message);
  else {
    homeworkForm.reset();
    loadHomework(); // reload all homework
  }
});

async function loadHomework() {
  const { data: homework, error } = await supabase
    .from('homework')
    .select('*')
    .order('created_at', { ascending: false });

  if (error) return console.error(error);
  hwList.innerHTML = '';

  homework.forEach(hw => {
    const card = document.createElement('div');
    card.className = 'card hw-card';
    card.innerHTML = `<div class="hw-meta">${hw.teacher} • ${hw.subject} • ${hw.section} • Due: ${hw.due_date||'N/A'}</div>
      <div class="hw-desc">${hw.description}</div>
      <div class="hw-images"></div>`;

    const imagesDiv = card.querySelector('.hw-images');
    hw.images.slice(0,4).forEach(url => {
      const imgWrap = document.createElement('div');
      imgWrap.className='img-wrap';
      const img = document.createElement('img'); img.src=url;
      imgWrap.appendChild(img);
      imagesDiv.appendChild(imgWrap);
    });
    if(hw.images.length>4){
      const more=document.createElement('div');
      more.className='img-wrap more-overlay';
      more.textContent=`+${hw.images.length-4}`;
      imagesDiv.appendChild(more);
    }
    hwList.appendChild(card);
  });
}

// load all homework on page load
loadHomework();
</script>
